<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <!-- Professional CSS Architecture - Handled by Vite -->
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Neon Drop - Block Puzzle Challenge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Neon Drop - BlockZone Lab</title>
    
    <!-- Favicon -->
    <link rel="icon" href="../../public/favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#000000">

    <!-- Performance Optimization: Resource Hints -->
    <link rel="dns-prefetch" href="https://api.blockzonelab.com">
    <link rel="preconnect" href="https://api.blockzonelab.com">
    
    <!-- Game-specific styles -->
    <link rel="stylesheet" href="../../assets/css/neondrop-game.css">
    
    <!-- Game wrapper styles (welcome screen, identity management) -->
    <link rel="stylesheet" href="../../assets/css/game-wrapper.css">
    
    <!-- Performance Analyzer - Removed (files deleted during optimization) -->
    
    <!-- Emergency pause system styles -->
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
    
    <!-- Development mode setup -->
    <script>
        // Set development mode flag
        window.isDevelopment = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1' ||
                             window.location.search.includes('dev=true');
        
        // Clean development mode - bypass paywall entirely
        if (window.location.search.includes('dev=true')) {
            window.devMode = {
                bypassPaywall: true,
                skipBackendChecks: false, // Keep essential backend checks
                enableDebugLogs: false // Performance optimized
            };
        }
        
        if (window.isDevelopment) {
            window.localStorage.setItem('debug', 'blockzonelab:*');
        }
    </script>
    
    <!-- Mobile Detection Script -->
    <script>
        // Mobile detection and CSS property setup for Neon Drop
        (function() {
            window.BlockZoneMobile = {
                _isMobile: window.innerWidth <= 768 || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent),
                _isTablet: window.innerWidth > 768 && window.innerWidth <= 1024 && 'ontouchstart' in window,
                _hasTouch: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
                _isPWA: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true,
                isMobile() { return this._isMobile; },
                isTablet() { return this._isTablet; },
                hasTouch() { return this._hasTouch; },
                isPWA() { return this._isPWA; },
                hasPhysicalKeyboard() { 
                    return !/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth > 1024;
                },
                needsMobileControls() {
                    return (this._isMobile || this._isTablet) && !this.hasPhysicalKeyboard();
                },
                getScreenSize() {
                    const w = window.innerWidth;
                    return w <= 480 ? 'small' : w <= 768 ? 'medium' : w <= 1024 ? 'large' : 'xlarge';
                }
            };
            document.documentElement.style.setProperty('--is-mobile', window.BlockZoneMobile._isMobile ? '1' : '0');
            document.documentElement.style.setProperty('--has-touch', window.BlockZoneMobile._hasTouch ? '1' : '0');
            document.documentElement.style.setProperty('--has-keyboard', window.BlockZoneMobile.hasPhysicalKeyboard() ? '1' : '0');
            document.documentElement.style.setProperty('--needs-mobile-controls', window.BlockZoneMobile.needsMobileControls() ? '1' : '0');
        })();
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Inter:wght@300;400;500;600&family=Bungee&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00d4ff">

    <!-- Web3 Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.8.1/ethers.umd.min.js" type="application/javascript"></script>
    <script>
        // Verify ethers is loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof ethers !== 'undefined') {
                window.ethers = ethers; // Make sure it's available globally
            }
        });
    </script>

</head>

<body class="game-page">
    <!-- Game Container -->
    <div id="gameContainer">
        <!-- Game Canvas -->
        <canvas id="bg"></canvas>
        <canvas id="game"></canvas>
    </div>
    
    <!-- Touch Controls (Responsive) -->
    <div id="touch-controls">
        <div class="touch-left">
            <button class="touch-btn" data-action="left">‚óÄ</button>
        </div>
        <div class="touch-center">
            <button class="touch-btn" data-action="down">‚ñº</button>
            <button class="touch-btn" data-action="rotate">‚Üª</button>
        </div>
        <div class="touch-right">
            <button class="touch-btn" data-action="right">‚ñ∂</button>
        </div>
        <div class="touch-bottom">
            <button class="touch-btn" data-action="drop">‚¨á‚¨á</button>
            <button class="touch-btn" data-action="hold">HOLD</button>
        </div>
    </div>

    <!-- UI Container -->
    <div id="ui-container"></div>

    <!-- HYBRID INSTANT PLAY + PERSISTENT PLAYER SYSTEM -->
    <!-- Revolutionary 0.1-0.3s game loading WITH full player persistence and paywall logic -->
    <script type="module">
        console.log('üöÄ Loading Hybrid Instant Play + Persistent Player Architecture...');
        
        // Import existing robust systems
        import IdentityManager from '../../shared/core/IdentityManager.js';
        import { PlayerProfile } from '../../shared/components/PlayerProfile.js';
        import { PaywallManager } from '../../shared/components/PaywallManager.js';
        
        // Progressive enhancement imports removed during dead wood cleanup
        
        // Create hybrid instant play system that preserves all existing functionality
        class NeonDropHybridInstantPlay {
            constructor() {
                this.startTime = performance.now();
                
                // Use singleton PlayerProfile to avoid multiple instances
                this.playerProfile = window.globalPlayerProfile || new PlayerProfile();
                if (!window.globalPlayerProfile) {
                    window.globalPlayerProfile = this.playerProfile;
                    console.log('üéØ Created global PlayerProfile singleton');
                } else {
                    console.log('üéØ Using existing global PlayerProfile singleton');
                }
                
                // Create IdentityManager as true singleton
                this.identityManager = window.identityManager || new IdentityManager();
                if (!window.identityManager) {
                    window.identityManager = this.identityManager;
                    console.log('üîê Created global IdentityManager singleton');
                } else {
                    console.log('üîê Using existing global IdentityManager singleton');
                }
                
                // Create PaywallManager (will be initialized later)
                this.paywallManager = new PaywallManager();
                
                this.gameStarted = false;
                this.onboardingComplete = false; // Flag to prevent cycling
                
                console.log('‚ö° NeonDrop Hybrid Instant Play: Initialized with optimized persistence');
            }
            
            async init() {
                try {
                    console.log('üéØ Target: Game playable in <200ms WITH player persistence');
                    
                    // CRITICAL FIX: Initialize IdentityManager FIRST to check for existing players
                    if (!this.identityManager.isInitialized) {
                        console.log('üîê Initializing IdentityManager to check for existing players...');
                        console.log('üîê IdentityManager state before initialization:');
                        console.log('  - this.identityManager:', this.identityManager);
                        console.log('  - this.identityManager.isInitialized:', this.identityManager.isInitialized);
                        console.log('  - this.identityManager.player:', this.identityManager.player);
                        
                        try {
                            await this.identityManager.initialize();
                            console.log('‚úÖ IdentityManager initialized successfully');
                            console.log('üîê IdentityManager state after initialization:');
                            console.log('  - this.identityManager.isInitialized:', this.identityManager.isInitialized);
                            console.log('  - this.identityManager.player:', this.identityManager.player);
                            console.log('  - this.identityManager.hasValidIdentity():', this.identityManager.hasValidIdentity());
                        } catch (initError) {
                            console.error('‚ùå IdentityManager initialization failed:', initError);
                            throw initError;
                        }
                    } else {
                        console.log('‚úÖ IdentityManager already initialized');
                    }
                    
                    // NOW check if player needs onboarding (after IdentityManager is initialized)
                    if (this.onboardingComplete) {
                        console.log('‚úÖ Onboarding already complete, proceeding with game initialization');
                    } else if (!this.identityManager.hasValidIdentity()) {
                        console.log('üé® Player needs onboarding - showing welcome system');
                        await this.showWelcomeSystem();
                        return; // Don't proceed until identity is established
                    }
                    
                    // CRITICAL PATH: Essential checks that must complete before game starts
                    const criticalPath = await this.initializeCriticalPath();
                    
                    // GAME START: Start game immediately with player context
                    await this.startGameWithContext(criticalPath);
                    
                    const totalTime = performance.now() - this.startTime;
                    const loadTime = totalTime.toFixed(1);
                // Performance metric logged in main.js - Phase 1 complete
                    
                    // BACKGROUND: Load all enhancements in parallel (non-blocking)
                    this.loadBackgroundEnhancements();
                    
                } catch (error) {
                    console.error('‚ùå Critical path failed:', error);
                    this.showFallback();
                }
            }
            
            // ENHANCED: Beautiful welcome system integration
            async showWelcomeSystem() {
                console.log('üé® Showing enhanced welcome system for new players');
                
                // Create welcome system overlay
                const overlay = document.createElement('div');
                overlay.id = 'neondrop-welcome';
                overlay.className = 'neondrop-welcome-overlay';
                
                overlay.innerHTML = `
                    <style>
                        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                        @keyframes neonGlow { 
                            0%, 100% { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; }
                            50% { text-shadow: 0 0 20px currentColor, 0 0 30px currentColor, 0 0 40px currentColor; }
                        }
                        @keyframes floatUp { 
                            0% { transform: translateY(20px); opacity: 0; }
                            100% { transform: translateY(0); opacity: 1; }
                        }
                        @keyframes chicletEntrance {
                            0% { transform: translateY(-30px) scale(0.3) rotate(10deg); opacity: 0; }
                            60% { transform: translateY(2px) scale(1.1) rotate(-3deg); opacity: 0.8; }
                            100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
                        }
                        
                        .neondrop-welcome-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100vw;
                            height: 100vh;
                            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 999999;
                            padding: 40px 20px;
                            box-sizing: border-box;
                            font-family: 'Bungee', monospace;
                        }
                        
                        .neon-title { animation: neonGlow 2s ease-in-out infinite; }
                        .info-line { animation: floatUp 0.6s ease-out forwards; }
                        .info-line:nth-child(1) { animation-delay: 0.1s; }
                        .info-line:nth-child(2) { animation-delay: 0.2s; }
                        .info-line:nth-child(3) { animation-delay: 0.3s; }
                        .info-line:nth-child(4) { animation-delay: 0.4s; }
                        .info-line:nth-child(5) { animation-delay: 0.5s; }
                        .info-line:nth-child(6) { animation-delay: 0.6s; }
                        
                        .welcome-container {
                            text-align: center !important;
                            max-width: 800px !important;
                            width: 90% !important;
                            padding: 40px 20px !important;
                        }
                        
                        .welcome-title {
                            font-size: 36px !important;
                            font-weight: bold !important;
                            color: #00d4ff !important;
                            margin-bottom: 20px !important;
                            text-shadow: 0 0 15px #00d4ff, 0 0 25px #00d4ff !important;
                            animation: neonGlow 2s ease-in-out infinite !important;
                            font-family: 'Bungee', monospace !important;
                        }
                        
                        .welcome-subtitle {
                            font-size: 18px !important;
                            color: #cccccc !important;
                            margin-bottom: 50px !important;
                            line-height: 1.5 !important;
                            text-shadow: 0 0 8px #cccccc !important;
                        }
                        
                        .identity-section {
                            margin-bottom: 40px !important;
                        }
                        
                        .identity-title {
                            font-size: 24px !important;
                            color: #ffffff !important;
                            margin-bottom: 15px !important;
                            text-shadow: 0 0 8px #ffffff !important;
                        }
                        
                        .identity-subtitle {
                            font-size: 16px !important;
                            color: #888888 !important;
                            margin-bottom: 25px !important;
                        }
                        
                        .game-name-input {
                            background: rgba(0, 212, 255, 0.1) !important;
                            border: 2px solid #00d4ff !important;
                            border-radius: 12px !important;
                            padding: 15px !important;
                            font-size: 18px !important;
                            color: #fff !important;
                            width: 100% !important;
                            max-width: 300px !important;
                            text-align: center !important;
                            outline: none !important;
                            transition: all 0.3s ease !important;
                            font-family: 'Bungee', monospace !important;
                        }
                        
                        .game-name-input:focus {
                            border-color: #00ff88 !important;
                            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3) !important;
                        }
                        
                        .error-message {
                            color: #ff4444 !important;
                            font-size: 14px !important;
                            margin-top: 10px !important;
                            display: none !important;
                        }
                        
                        .security-notice {
                            margin-bottom: 50px !important;
                        }
                        
                        .security-title {
                            font-size: 16px !important;
                            color: #ffd700 !important;
                            margin-bottom: 5px !important;
                            text-shadow: 0 0 8px #ffd700 !important;
                        }
                        
                        .security-subtitle {
                            font-size: 14px !important;
                            color: #cccccc !important;
                        }
                        
                        .start-button {
                            background: none !important;
                            color: #00d4ff !important;
                            border: 2px solid #00d4ff !important;
                            padding: 15px 30px !important;
                            border-radius: 8px !important;
                            font-size: 18px !important;
                            font-weight: bold !important;
                            cursor: pointer !important;
                            transition: all 0.3s ease !important;
                            text-shadow: 0 0 10px #00d4ff !important;
                            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3) !important;
                            font-family: 'Bungee', monospace !important;
                        }
                        
                        .start-button:hover {
                            background-color: rgba(0, 212, 255, 0.1) !important;
                            box-shadow: 0 0 25px rgba(0, 212, 255, 0.5) !important;
                        }
                        
                        .start-button:disabled {
                            opacity: 0.5 !important;
                            cursor: not-allowed !important;
                        }
                        
                        .device-info {
                            background: rgba(0, 212, 255, 0.05) !important;
                            border: 1px solid rgba(0, 212, 255, 0.2) !important;
                            border-radius: 8px !important;
                            padding: 15px !important;
                            margin: 20px 0 !important;
                            font-size: 12px !important;
                            color: #888888 !important;
                        }
                    </style>
                    
                    <div class="welcome-container">
                        <!-- NEON DROP Title -->
                        <div style="margin-bottom: 60px;">
                            <div style="
                                font-size: 48px !important;
                                font-weight: bold !important;
                                margin-bottom: 10px !important;
                            ">
                                <span style="color: #FFFF00 !important;" class="neon-title">NEON</span>
                                <span style="color: #8A2BE2 !important;" class="neon-title">DROP</span>
                            </div>
                        </div>
                        
                        <!-- Welcome Title -->
                        <div class="welcome-title info-line">Welcome to BlockZone Lab!</div>
                        
                        <!-- Subtitle -->
                        <div class="welcome-subtitle info-line">Choose your game name to start your Web3 gaming journey</div>
                        
                        <!-- Device Fingerprint Info -->
                        <div class="device-info info-line">
                            <strong>üîê Device ID:</strong> ${this.identityManager.getDeviceFingerprint() || 'Generating...'}<br>
                            <strong>üåê Platform:</strong> ${navigator.platform || 'Unknown'}
                        </div>
                        
                        <!-- Identity Section -->
                        <div class="identity-section">
                            <div class="identity-title info-line">Your Gaming Identity</div>
                            
                            <div class="identity-subtitle info-line">Enter your game name (3-12 characters):</div>
                            
                            <input type="text" 
                                   id="gameNameInput" 
                                   class="game-name-input"
                                   placeholder="Enter your game name..."
                                   maxlength="12"
                                   autocomplete="off">
                            
                            <div id="errorMessage" class="error-message">Game name must be 3-12 characters long</div>
                        </div>
                        
                        <!-- Security Notice -->
                        <div class="security-notice">
                            <div class="security-title info-line">Seamless Web3 Identity</div>
                            <div class="security-subtitle info-line">We'll create a real blockchain wallet tied to your username</div>
                        </div>
                        
                        <!-- Action Button -->
                        <div style="
                            display: flex !important;
                            gap: 30px !important;
                            justify-content: center !important;
                            flex-wrap: wrap !important;
                        ">
                            <button id="startGameBtn" class="start-button info-line">
                                Start Gaming
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // Focus on input
                const input = document.getElementById('gameNameInput');
                if (input) {
                    input.focus();
                }
                
                // Input validation
                input.addEventListener('input', (e) => {
                    const value = e.target.value.trim();
                    const errorDiv = document.getElementById('errorMessage');
                    const startBtn = document.getElementById('startGameBtn');
                    
                    if (value.length >= 3) {
                        errorDiv.style.display = 'none';
                        startBtn.disabled = false;
                        startBtn.style.opacity = '1';
                    } else {
                        errorDiv.style.display = 'block';
                        startBtn.disabled = true;
                        startBtn.style.opacity = '0.5';
                    }
                });
                
                // Enter key handler
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const value = input.value.trim();
                        if (value.length >= 3) {
                            this.handleGameNameSubmit(value, overlay);
                        }
                    }
                });
                
                // Button handler
                document.getElementById('startGameBtn').addEventListener('click', () => {
                    const value = input.value.trim();
                    if (value.length >= 3) {
                        this.handleGameNameSubmit(value, overlay);
                    }
                });
            }
            
            // Handle game name submission
            async handleGameNameSubmit(gameName, overlay) {
                console.log('üéØ Player submitted game name:', gameName);
                
                try {
                    // Debug: Check IdentityManager state before creation
                    console.log('üîç IdentityManager state BEFORE identity creation:');
                    console.log('  - this.identityManager:', this.identityManager);
                    console.log('  - this.identityManager.isInitialized:', this.identityManager.isInitialized);
                    console.log('  - this.identityManager.player:', this.identityManager.player);
                    console.log('  - this.identityManager.hasValidIdentity():', this.identityManager.hasValidIdentity());
                    
                    // Create player identity with the game name using the new method
                    await this.identityManager.createIdentityWithGameName(gameName);
                    
                    // Debug: Check IdentityManager state after creation
                    console.log('üîç IdentityManager state AFTER identity creation:');
                    console.log('  - this.identityManager:', this.identityManager);
                    console.log('  - this.identityManager.isInitialized:', this.identityManager.isInitialized);
                    console.log('  - this.identityManager.player:', this.identityManager.player);
                    console.log('  - this.identityManager.hasValidIdentity():', this.identityManager.hasValidIdentity());
                    
                    // Remove welcome overlay
                    if (overlay && overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    
                    // Mark onboarding as complete to prevent cycling
                    this.onboardingComplete = true;
                    console.log('‚úÖ Onboarding marked as complete');
                    
                    // Now proceed with normal game initialization
                    console.log('‚úÖ Identity created, proceeding with game initialization');
                    
                    // Ensure PaywallManager is initialized
                    if (this.paywallManager && !this.paywallManager.identityManager) {
                        await this.paywallManager.initialize(this.identityManager);
                    }
                    
                    // Show payment options directly - this prevents cycling
                    if (this.paywallManager) {
                        console.log('üí∞ Showing payment options via PaywallManager');
                        this.paywallManager.showPaymentOptions('neondrop', {}, null);
                        console.log('üí∞ Payment options displayed - should not cycle back to welcome');
                    } else {
                        console.error('‚ùå PaywallManager not available - this should not happen');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to create identity:', error);
                    // Show error message to user
                    const errorDiv = document.getElementById('errorMessage');
                    if (errorDiv) {
                        errorDiv.textContent = 'Failed to create identity. Please try again.';
                        errorDiv.style.display = 'block';
                    }
                }
            }
            
            async initializeCriticalPath() {
                // CRITICAL PATH: Essential checks that must complete before game starts
                
                try {
                    // Parallel loading of essential systems + game assets
                    const [identityResult, paywallResult, gameAssets] = await Promise.all([
                        this.identityManager.initialize(),
                        this.paywallManager.initialize(this.identityManager),
                        this.preloadGameAssets()
                    ]);
                    
                    // Make available globally for compatibility
                    window.identityManager = this.identityManager;
                    window.paywallManager = this.paywallManager;
                    window.playerProfile = this.playerProfile;
                    
                    // Critical path ready
                    
                    return {
                        playerData: identityResult,
                        paywallStatus: paywallResult,
                        gameAssets: gameAssets
                    };
                    
                } catch (error) {
                    console.error('‚ùå Critical path failed:', error);
                    throw error;
                }
            }
            
            async preloadGameAssets() {
                // Performance: Only preload what we immediately use
                try {
                    // CRITICAL PATH: Only preload main.js since it's used immediately
                    const mainModule = await import('./main.js?v=' + Date.now());
                    
                    return { 
                        mainModule: mainModule
                    };
                    
                } catch (error) {
                    return null;
                }
            }
            

            
            async startGameWithContext(criticalPath) {
                // GAME START: Start game immediately with player context
                
                try {
                    // Check paywall before starting game
                    if (this.paywallManager) {
                        const allowed = await this.paywallManager.interceptGameStart('neondrop');
                        if (!allowed) {
                            return; // Don't start the game, paywall will handle it
                        }
                    }
                    
                    // Use preloaded game assets if available
                    if (criticalPath.gameAssets && criticalPath.gameAssets.gameEntryModule) {
                        const gameEntryModule = criticalPath.gameAssets.gameEntryModule;
                        if (gameEntryModule && gameEntryModule.startGame) {
                            await this.startGameWithPreloadedAssets(gameEntryModule.startGame);
                        } else {
                            await this.loadNeonDropGameInstantly();
                        }
                    } else {
                        await this.loadNeonDropGameInstantly();
                    }
                    
                    // Setup paywall logic for subsequent games (non-blocking)
                    this.setupPaywallLogic();
                    
                } catch (error) {
                    console.error('‚ùå Game start failed:', error);
                    throw error;
                }
            }
            
            async startGameWithPreloadedAssets(startGame) {
                // Start game with preloaded assets (much faster)
                console.log('üéÆ Starting NeonDrop with preloaded assets');
                
                // Paywall already checked - just start the game
                await startGame();
                this.gameStarted = true;
                
                // Connect game events to our hybrid system
                this.connectGameEvents();
            }
            
            loadBackgroundEnhancements() {
                // BACKGROUND: Load all enhancements in parallel (non-blocking)
                
                Promise.all([
                    this.loadProgressiveUI(),
                    this.loadBlockchainFeatures(),
                    this.loadTournamentData()
                ]).then(() => {
                    // Advanced features ready
                }).catch(error => {
                    // Background features failed to load - game continues with graceful degradation
                });
            }
            
            async loadProgressiveUI() {
                // Progressive UI removed during dead wood cleanup
                console.log('üé® Progressive UI features disabled');
            }
            
            async loadBlockchainFeatures() {
                // Blockchain features (non-blocking)
                setTimeout(() => {
                    console.log('üîó Blockchain features loading in background...');
                    // Blockchain initialization happens here
                }, 200);
            }
            
            async loadTournamentData() {
                // Tournament data (non-blocking)
                setTimeout(() => {
                    console.log('üèÜ Tournament data loading in background...');
                    // Tournament leaderboards and data
                }, 300);
            }
            
            async loadNeonDropGameInstantly() {
                // Import and start NeonDrop game directly (instant)
                const { startGame } = await import('./game-entry.js');
                
                console.log('üéÆ Starting NeonDrop instantly (player persistence will sync in background)');
                
                // Paywall already checked - just start the game
                await startGame();
                this.gameStarted = true;
                
                // Connect game events to our hybrid system
                this.connectGameEvents();
            }
            
            connectGameEvents() {
                // Paywall already checked at game start - no need for additional checks
                console.log('üéÆ Game events connected - paywall already handled');
                
                // Listen for game over events
                window.addEventListener('gameOver', (event) => {
                    const { score } = event.detail;
                    this.handleGameOver(score);
                });
            }
            
            setupPaywallLogic() {
                // Paywall already checked once at game start - no need for additional checks
                console.log('üí∞ Paywall logic already handled at game start');
            }
            
            setupProgressiveEnhancements() {
                // Initialize progressive UI for post-game enhancements
                setTimeout(() => {
                    if (window.identityManager) {
                        this.progressiveUI = new ProgressiveUI({
                            getPlayer: () => window.identityManager.getPlayer(),
                            gameAPI: this.gameAPI
                        });
                        console.log('üé® Progressive UI ready for post-game enhancements');
                    }
                }, 200);
                
                console.log('üîÑ Progressive enhancements loading in background...');
            }
            
            handleGameOver(score) {
                console.log('üéÆ Game over - score:', score);
                
                // Let the existing game over system handle everything
                // Our progressive UI can enhance it if needed
                if (this.progressiveUI && score > 1000) {
                    setTimeout(() => {
                        this.progressiveUI.showHighScoreCelebration(score);
                    }, 2000);
                }
            }
            
            showFallback() {
                console.log('üÜò Showing fallback - loading legacy system');
                // Fallback to legacy system if hybrid fails
                import('./game-entry.js').catch(error => {
                    console.error('‚ùå Even fallback failed:', error);
                    document.body.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: white; text-align: center;">
                            <div>
                                <h2>üéÆ Game Loading...</h2>
                                <p>Preparing your gaming experience...</p>
                                <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">Retry</button>
                            </div>
                        </div>
                    `;
                });
            }
        }
        
        // Initialize hybrid system when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Set log level based on environment
            window.logLevel = window.location.hostname.includes('pages.dev') ? 'production' : 'development';
            
            if (window.logLevel === 'production') {
                console.log('üéÆ BlockZone Lab - NeonDrop');
            } else {
                console.log('üåü NeonDrop - Hybrid Instant Play + Persistent Player Architecture');
            }
            
            const hybridSystem = new NeonDropHybridInstantPlay();
            window.neonDropHybridSystem = hybridSystem;
            
            // Only call init() if onboarding is not complete
            if (!hybridSystem.onboardingComplete) {
                await hybridSystem.init();
            } else {
                console.log('‚úÖ Onboarding already complete, skipping init() to prevent cycling');
            }
        });
        
    </script>
</body>
</html>