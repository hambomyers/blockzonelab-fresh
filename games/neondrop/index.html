<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <!-- Professional CSS Architecture - Handled by Vite -->
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Neon Drop - Block Puzzle Challenge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Neon Drop - BlockZone Lab</title>
    
    <!-- Favicon -->
    <link rel="icon" href="../../public/favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#000000">

    <!-- Performance Optimization: Resource Hints -->
    <link rel="dns-prefetch" href="https://api.blockzonelab.com">
    <link rel="preconnect" href="https://api.blockzonelab.com">
    
    <!-- Game-specific styles -->
    <link rel="stylesheet" href="../../assets/css/neondrop-game.css">
    
    <!-- Game wrapper styles (welcome screen, identity management) -->
    <link rel="stylesheet" href="../../assets/css/game-wrapper.css">
    
    <!-- Performance Analyzer - Removed (files deleted during optimization) -->
    
    <!-- Emergency pause system styles -->
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
    
    <!-- Development mode setup -->
    <script>
        // Set development mode flag
        window.isDevelopment = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1' ||
                             window.location.search.includes('dev=true');
        
        // Clean development mode - bypass paywall entirely
        if (window.location.search.includes('dev=true')) {
            window.devMode = {
                bypassPaywall: true,
                skipBackendChecks: false, // Keep essential backend checks
                enableDebugLogs: false // Performance optimized
            };
        }
        
        if (window.isDevelopment) {
            window.localStorage.setItem('debug', 'blockzonelab:*');
        }
    </script>
    
    <!-- Mobile Detection Script -->
    <script>
        // Mobile detection and CSS property setup for Neon Drop
        (function() {
            window.BlockZoneMobile = {
                _isMobile: window.innerWidth <= 768 || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent),
                _isTablet: window.innerWidth > 768 && window.innerWidth <= 1024 && 'ontouchstart' in window,
                _hasTouch: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
                _isPWA: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true,
                isMobile() { return this._isMobile; },
                isTablet() { return this._isTablet; },
                hasTouch() { return this._hasTouch; },
                isPWA() { return this._isPWA; },
                hasPhysicalKeyboard() { 
                    return !/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth > 1024;
                },
                needsMobileControls() {
                    return (this._isMobile || this._isTablet) && !this.hasPhysicalKeyboard();
                },
                getScreenSize() {
                    const w = window.innerWidth;
                    return w <= 480 ? 'small' : w <= 768 ? 'medium' : w <= 1024 ? 'large' : 'xlarge';
                }
            };
            document.documentElement.style.setProperty('--is-mobile', window.BlockZoneMobile._isMobile ? '1' : '0');
            document.documentElement.style.setProperty('--has-touch', window.BlockZoneMobile._hasTouch ? '1' : '0');
            document.documentElement.style.setProperty('--has-keyboard', window.BlockZoneMobile.hasPhysicalKeyboard() ? '1' : '0');
            document.documentElement.style.setProperty('--needs-mobile-controls', window.BlockZoneMobile.needsMobileControls() ? '1' : '0');
        })();
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Inter:wght@300;400;500;600&family=Bungee&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00d4ff">

    <!-- Web3 Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.8.1/ethers.umd.min.js" type="application/javascript"></script>
    <script>
        // Verify ethers is loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof ethers !== 'undefined') {
                window.ethers = ethers; // Make sure it's available globally
            }
        });
    </script>

</head>

<body class="game-page">
    <!-- Game Container -->
    <div id="gameContainer">
        <!-- Game Canvas -->
        <canvas id="bg"></canvas>
        <canvas id="game"></canvas>
    </div>
    
    <!-- Touch Controls (Responsive) -->
    <div id="touch-controls">
        <div class="touch-left">
            <button class="touch-btn" data-action="left">‚óÄ</button>
        </div>
        <div class="touch-center">
            <button class="touch-btn" data-action="down">‚ñº</button>
            <button class="touch-btn" data-action="rotate">‚Üª</button>
        </div>
        <div class="touch-right">
            <button class="touch-btn" data-action="right">‚ñ∂</button>
        </div>
        <div class="touch-bottom">
            <button class="touch-btn" data-action="drop">‚¨á‚¨á</button>
            <button class="touch-btn" data-action="hold">HOLD</button>
        </div>
    </div>

    <!-- UI Container -->
    <div id="ui-container"></div>

    <!-- HYBRID INSTANT PLAY + PERSISTENT PLAYER SYSTEM -->
    <!-- Revolutionary 0.1-0.3s game loading WITH full player persistence and paywall logic -->
    <script type="module">
        console.log('üöÄ Loading Hybrid Instant Play + Persistent Player Architecture...');
        
        // Import existing robust systems
        import IdentityManager from '../../shared/core/IdentityManager.js';
        import { PlayerProfile } from '../../shared/components/PlayerProfile.js';
        import { PaywallManager } from '../../shared/components/PaywallManager.js';
        
        // Progressive enhancement imports removed during dead wood cleanup
        
        // Create hybrid instant play system that preserves all existing functionality
        class NeonDropHybridInstantPlay {
            constructor() {
                this.startTime = performance.now();
                
                // Use singleton PlayerProfile to avoid multiple instances
                this.playerProfile = window.globalPlayerProfile || new PlayerProfile();
                if (!window.globalPlayerProfile) {
                    window.globalPlayerProfile = this.playerProfile;
                    console.log('üéØ Created global PlayerProfile singleton');
                } else {
                    console.log('üéØ Using existing global PlayerProfile singleton');
                }
                
                // Create IdentityManager as true singleton
                this.identityManager = window.identityManager || new IdentityManager();
                if (!window.identityManager) {
                    window.identityManager = this.identityManager;
                    console.log('üîê Created global IdentityManager singleton');
                } else {
                    console.log('üîê Using existing global IdentityManager singleton');
                }
                
                this.paywallManager = new PaywallManager();
                this.gameStarted = false;
                
                console.log('‚ö° NeonDrop Hybrid Instant Play: Initialized with optimized persistence');
            }
            
            async init() {
                try {
                    console.log('üéØ Target: Game playable in <200ms WITH player persistence');
                    
                    // CRITICAL PATH: Essential checks that must complete before game starts
                    const criticalPath = await this.initializeCriticalPath();
                    
                    // GAME START: Start game immediately with player context
                    await this.startGameWithContext(criticalPath);
                    
                    const totalTime = performance.now() - this.startTime;
                    const loadTime = totalTime.toFixed(1);
                // Performance metric logged in main.js - Phase 1 complete
                    
                    // BACKGROUND: Load all enhancements in parallel (non-blocking)
                    this.loadBackgroundEnhancements();
                    
                } catch (error) {
                    console.error('‚ùå Critical path failed:', error);
                    this.showFallback();
                }
            }
            
            async initializeCriticalPath() {
                // CRITICAL PATH: Essential checks that must complete before game starts
                
                try {
                    // Parallel loading of essential systems + game assets
                    const [identityResult, paywallResult, gameAssets] = await Promise.all([
                        this.identityManager.initialize(),
                        this.paywallManager.initialize(this.identityManager),
                        this.preloadGameAssets()
                    ]);
                    
                    // Make available globally for compatibility
                    window.identityManager = this.identityManager;
                    window.paywallManager = this.paywallManager;
                    window.playerProfile = this.playerProfile;
                    
                    // Critical path ready
                    
                    return {
                        playerData: identityResult,
                        paywallStatus: paywallResult,
                        gameAssets: gameAssets
                    };
                    
                } catch (error) {
                    console.error('‚ùå Critical path failed:', error);
                    throw error;
                }
            }
            
            async preloadGameAssets() {
                // Performance: Only preload what we immediately use
                try {
                    // CRITICAL PATH: Only preload main.js since it's used immediately
                    const mainModule = await import('./main.js?v=' + Date.now());
                    
                    return { 
                        mainModule: mainModule
                    };
                    
                } catch (error) {
                    return null;
                }
            }
            

            
            async startGameWithContext(criticalPath) {
                // GAME START: Start game immediately with player context
                
                try {
                    // Check paywall before starting game
                    if (this.paywallManager) {
                        const allowed = await this.paywallManager.interceptGameStart('neondrop');
                        if (!allowed) {
                            return; // Don't start the game, paywall will handle it
                        }
                    }
                    
                    // Use preloaded game assets if available
                    if (criticalPath.gameAssets && criticalPath.gameAssets.gameEntryModule) {
                        const gameEntryModule = criticalPath.gameAssets.gameEntryModule;
                        if (gameEntryModule && gameEntryModule.startGame) {
                            await this.startGameWithPreloadedAssets(gameEntryModule.startGame);
                        } else {
                            await this.loadNeonDropGameInstantly();
                        }
                    } else {
                        await this.loadNeonDropGameInstantly();
                    }
                    
                    // Setup paywall logic for subsequent games (non-blocking)
                    this.setupPaywallLogic();
                    
                } catch (error) {
                    console.error('‚ùå Game start failed:', error);
                    throw error;
                }
            }
            
            async startGameWithPreloadedAssets(startGame) {
                // Start game with preloaded assets (much faster)
                console.log('üéÆ Starting NeonDrop with preloaded assets');
                
                // Paywall already checked - just start the game
                await startGame();
                this.gameStarted = true;
                
                // Connect game events to our hybrid system
                this.connectGameEvents();
            }
            
            loadBackgroundEnhancements() {
                // BACKGROUND: Load all enhancements in parallel (non-blocking)
                
                Promise.all([
                    this.loadProgressiveUI(),
                    this.loadBlockchainFeatures(),
                    this.loadTournamentData()
                ]).then(() => {
                    // Advanced features ready
                }).catch(error => {
                    // Background features failed to load - game continues with graceful degradation
                });
            }
            
            async loadProgressiveUI() {
                // Progressive UI removed during dead wood cleanup
                console.log('üé® Progressive UI features disabled');
            }
            
            async loadBlockchainFeatures() {
                // Blockchain features (non-blocking)
                setTimeout(() => {
                    console.log('üîó Blockchain features loading in background...');
                    // Blockchain initialization happens here
                }, 200);
            }
            
            async loadTournamentData() {
                // Tournament data (non-blocking)
                setTimeout(() => {
                    console.log('üèÜ Tournament data loading in background...');
                    // Tournament leaderboards and data
                }, 300);
            }
            
            async loadNeonDropGameInstantly() {
                // Import and start NeonDrop game directly (instant)
                const { startGame } = await import('./game-entry.js');
                
                console.log('üéÆ Starting NeonDrop instantly (player persistence will sync in background)');
                
                // Paywall already checked - just start the game
                await startGame();
                this.gameStarted = true;
                
                // Connect game events to our hybrid system
                this.connectGameEvents();
            }
            
            connectGameEvents() {
                // Paywall already checked at game start - no need for additional checks
                console.log('üéÆ Game events connected - paywall already handled');
                
                // Listen for game over events
                window.addEventListener('gameOver', (event) => {
                    const { score } = event.detail;
                    this.handleGameOver(score);
                });
            }
            
            setupPaywallLogic() {
                // Paywall already checked once at game start - no need for additional checks
                console.log('üí∞ Paywall logic already handled at game start');
            }
            
            setupProgressiveEnhancements() {
                // Initialize progressive UI for post-game enhancements
                setTimeout(() => {
                    if (window.identityManager) {
                        this.progressiveUI = new ProgressiveUI({
                            getPlayer: () => window.identityManager.getPlayer(),
                            gameAPI: this.gameAPI
                        });
                        console.log('üé® Progressive UI ready for post-game enhancements');
                    }
                }, 200);
                
                console.log('üîÑ Progressive enhancements loading in background...');
            }
            
            handleGameOver(score) {
                console.log('üéÆ Game over - score:', score);
                
                // Let the existing game over system handle everything
                // Our progressive UI can enhance it if needed
                if (this.progressiveUI && score > 1000) {
                    setTimeout(() => {
                        this.progressiveUI.showHighScoreCelebration(score);
                    }, 2000);
                }
            }
            
            showFallback() {
                console.log('üÜò Showing fallback - loading legacy system');
                // Fallback to legacy system if hybrid fails
                import('./game-entry.js').catch(error => {
                    console.error('‚ùå Even fallback failed:', error);
                    document.body.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: white; text-align: center;">
                            <div>
                                <h2>üéÆ Game Loading...</h2>
                                <p>Preparing your gaming experience...</p>
                                <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">Retry</button>
                            </div>
                        </div>
                    `;
                });
            }
        }
        
        // Initialize hybrid system when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Set log level based on environment
            window.logLevel = window.location.hostname.includes('pages.dev') ? 'production' : 'development';
            
            if (window.logLevel === 'production') {
                console.log('üéÆ BlockZone Lab - NeonDrop');
            } else {
                console.log('üåü NeonDrop - Hybrid Instant Play + Persistent Player Architecture');
            }
            
            const hybridSystem = new NeonDropHybridInstantPlay();
            window.neonDropHybridSystem = hybridSystem;
            
            await hybridSystem.init();
        });
        
    </script>
</body>
</html>