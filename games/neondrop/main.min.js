import{GameEngine as f}from"./core/game-engine.js";import{AudioSystem as w}from"./core/audio-system.js";import{Renderer as E}from"./core/renderer.js";import{Config as S,GAME_CONFIG as l}from"./config.js";import{GameOverSystem as v}from"./game-over.js";import{ViewportManager as A}from"./core/viewport-manager.js";import{ProfessionalRNG as d}from"./core/game-engine.js";import{gameWrapper as r}from"/shared/wrapper/GameWrapper.js";import{GameContext as P}from"/shared/core/game-context.js";import{OverlayManager as p}from"/shared/core/overlay-manager.js";import{GameStateMachine as g,GameState as y}from"/shared/core/game-states.js";import{BlockchainManager as R}from"/shared/wrapper/BlockchainManager.js";let c,u,h,m;class T{constructor(){this.listeners={}}on(e,n){var t;((t=this.listeners)[e]||(t[e]=[])).push(n)}off(e,n){this.listeners[e]=(this.listeners[e]||[]).filter(t=>t!==n)}emit(e,n){(this.listeners[e]||[]).forEach(t=>t(n))}}window.gameInstanceCount=(window.gameInstanceCount||0)+1;document.addEventListener("gameOverUIReady",o=>{const e=o.detail||{};window.eventBus&&typeof window.eventBus.emit=="function"?window.eventBus.emit("gameOverUIReady",e):window.neonDrop&&window.neonDrop.eventBus&&typeof window.neonDrop.eventBus.emit=="function"&&window.neonDrop.eventBus.emit("gameOverUIReady",e)});class I{constructor(){this.instanceId=window.gameInstanceCount,this.logLevel=window.location.hostname==="localhost"?1:0,this.phase1StartTime=performance.now(),this.config=new S,this.viewport=new A,this.eventBus=new T,this.stateMachine=new g(this.eventBus),this.overlayManager=new p(this.eventBus),this.gameContext=null,this.engine=null,this.renderer=null,this.audio=null,this.input=null,this.particles=null,this.scoring=null,this.starfield=null,this.nonCriticalModulesLoaded=!1,this.gameOverHandler=null,this.running=!1,this.lastTime=0,this.accumulator=0,this.isGameOverReady=!1,this.eventsBound=!1,this.gameOverEventBound=!1,this.gameOverProcessing=!1,this.scoreSubmitted=!1}log(e,n){this.logLevel>=e}measurePerformance(e,n){return async(...t)=>{const i=performance.now(),s=await n.apply(this,t),a=performance.now()-i;return s}}state(){return this.engine&&this.engine.getState?this.engine.getState():{}}logPerformance(){}async initialize(){try{this.log(1,"ðŸš€ NeonDrop: Starting parallel initialization..."),await this.initCriticalSystemsParallel(),this.scheduleBackgroundLoading()}catch(e){this.showError("Game initialization failed: "+e.message)}}async initCriticalSystemsParallel(){window.timeStart&&window.timeStart("initCriticalSystemsParallel");const[e,n]=await Promise.all([this.setupDisplayParallel(),this.createSystemsParallel()]);this.startLoop(),this.bindEvents();const t=Math.round(performance.now()-this.phase1StartTime);window.timeEnd&&window.timeEnd("initCriticalSystemsParallel")}scheduleBackgroundLoading(){setTimeout(()=>{this.initBackgroundSystems()},1e3)}async initBackgroundSystems(){setTimeout(async()=>{try{window.skipValidation||typeof r<"u"&&r.validateIdentity&&r.validateIdentity()}catch{}},1e3),setTimeout(()=>{this.cleanupOldUI()},500),setTimeout(()=>{this.loadAdvancedSystemsInBackground()},100),setTimeout(async()=>{this.blockchainManager=new R,await this.initBlockchainInBackground()},2e3),setTimeout(()=>{this.logPerformance()},3e3)}async setupDisplayParallel(){window.timeStart&&window.timeStart("setupDisplayParallel");const e=document.getElementById("game"),n=document.getElementById("bg");if(!e||!n)throw new Error("Canvas elements missing");const t=this.viewport.calculateOptimalDimensions(innerWidth,innerHeight);return e.width=t.canvasWidth,e.height=t.canvasHeight,n.width=innerWidth,n.height=innerHeight,this.renderer=new E(e,n,this.config,t),this.renderer.viewportManager=this.viewport,window.timeEnd&&window.timeEnd("setupDisplayParallel"),this.precomputeRendererAssets(),this.upgradeToPremiumRenderer(),!0}precomputeRendererAssets(){this.renderer&&this.renderer.ctx&&(this.gradientCache={background:this.renderer.ctx.createLinearGradient(0,0,0,this.renderer.canvas.height),glow:this.renderer.ctx.createRadialGradient(0,0,0,0,0,100)},this.gradientCache.background.addColorStop(0,"#1a1a2e"),this.gradientCache.background.addColorStop(1,"#16213e"),this.renderer.gradientCache=this.gradientCache)}setupDisplay(){return this.setupDisplayParallel()}upgradeToPremiumRenderer(){setTimeout(()=>{this.renderer&&(this.renderer.initialize&&this.renderer.initialize(),this.renderer.upgradeToPremium&&this.renderer.upgradeToPremium())},100)}async createSystemsParallel(){window.timeStart&&window.timeStart("createSystemsParallel"),this.engine=new f(this.config,null,null,this.eventBus);const e=await Promise.all([this.generateDailySeedFast(),this.createOverlaySystems(),this.setupMinimalInput()]);this.gameOverHandler&&this.engine&&this.engine.setGameOverSystem(this.gameOverHandler),this.setupUIBatched(),this.scheduleNonCriticalSystems();const n=performance.now()-(window.timeStart?window.timeStart("createSystemsParallel"):0);return window.timeEnd&&window.timeEnd("createSystemsParallel"),e}async generateDailySeedFast(){const e=new Date().toISOString().split("T")[0],n=`dailySeed_${e}`;try{const s=localStorage.getItem(n);if(s){const a=JSON.parse(s);return this.dailySeed=a.seed,this.seedDate=e,this.engine.rng=new d(a.processed),a}}catch{}const t=this.hashString(e),i=t*1689048361;try{localStorage.setItem(n,JSON.stringify({seed:t,processed:i,date:e}))}catch{}return this.dailySeed=t,this.seedDate=e,this.engine.rng=new d(i),{seed:t,processed:i}}hashString(e){let n=0;const t=`neondrop_${e}`;for(let i=0;i<t.length;i++)n=(n<<5)-n+t.charCodeAt(i),n=n&n;return Math.abs(n)}async cacheGameEngineSeed(){return this.generateDailySeedFast()}async getVerifiedDailySeed(){const e=new Date().toISOString().split("T")[0];let n=0;const t=`neondrop_${e}`;for(let i=0;i<t.length;i++)n=(n<<5)-n+t.charCodeAt(i),n=n&n;return Math.abs(n)}async createOverlaySystems(){return this.overlayManager=new p(this.eventBus),this.gameOverHandler=new v(this.eventBus),this.overlayManager.registerOverlay("gameOver",this.gameOverHandler),!0}async createSystems(){return this.createSystemsParallel()}scheduleNonCriticalSystems(){setTimeout(()=>{this.loadNonCriticalSystems()},50)}async loadNonCriticalSystems(){try{await this.loadFullInputController()}catch{}const e=[this.loadAdvancedSystemsInBackground?.(),this.setupGamepadSupport?.(),this.preloadAssets?.(),this.initializeAnalytics?.(),this.setupAdvancedAudio?.()].filter(Boolean);try{await Promise.all(e)}catch{}}async loadFullInputController(){return this.loadInputController()}setupGamepadSupport(){return Promise.resolve()}preloadAssets(){return Promise.resolve()}initializeAnalytics(){return Promise.resolve()}setupAdvancedAudio(){return Promise.resolve()}loadAdvancedSystemsInBackground(){setTimeout(async()=>{try{this.stateMachine=new g(this.eventBus),this.audio=new w(this.config),this.audio.init(),this.engine.setAudioSystem(this.audio),this.loadNonCriticalSystems(),this.gameContext=new P({eventBus:this.eventBus,engine:this.engine,overlays:this.overlayManager,audio:this.audio})}catch{}},100)}setupMinimalInput(){const e=this;this.input={activeKeys:new Set,autoRepeatTimers:new Map,autoRepeatDelays:{initial:200,repeat:50},parent:e,keyToAction:t=>({ArrowLeft:{type:"MOVE",dx:-1,dy:0},KeyA:{type:"MOVE",dx:-1,dy:0},ArrowRight:{type:"MOVE",dx:1,dy:0},KeyD:{type:"MOVE",dx:1,dy:0},ArrowDown:{type:"MOVE",dx:0,dy:1},KeyS:{type:"MOVE",dx:0,dy:1},ArrowUp:{type:"ROTATE",direction:1},KeyW:{type:"ROTATE",direction:1},KeyZ:{type:"ROTATE",direction:-1},ShiftLeft:{type:"ROTATE",direction:-1},KeyX:{type:"ROTATE",direction:1},ControlLeft:{type:"ROTATE",direction:1},ControlRight:{type:"ROTATE",direction:1},Space:{type:"HARD_DROP"},KeyF:{type:"HARD_DROP"},KeyC:{type:"HOLD"},ShiftRight:{type:"HOLD"},Escape:{type:"PAUSE"},Enter:{type:"ENTER"},KeyP:{type:"PAUSE"}})[t],onKeyDown:t=>{const i=e.engine?.getState();if(i&&i.phase==="MENU"&&(t.code==="Space"||t.code==="Enter")){if(t.preventDefault(),e.input.activeKeys.has(t.code))return;e.input.activeKeys.add(t.code),e.handleAction({type:"START_GAME"});return}if(!e.input.shouldCaptureGameKeys()||(e.input.isGameKey(t.code)&&t.preventDefault(),e.input.activeKeys.has(t.code)))return;e.input.activeKeys.add(t.code);const s=e.input.keyToAction(t.code);s&&(e.input.processAction(s),s.type==="MOVE"&&(s.dx!==0||s.dy!==0)&&e.input.startAutoRepeat(t.code,s))},onKeyUp:t=>{e.input.activeKeys.delete(t.code),e.input.stopAutoRepeat(t.code)},shouldCaptureGameKeys(){const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.contentEditable==="true"))return!1;const i=e.engine?.getState(),s=["PLAYING","LOCKING","COUNTDOWN","PAUSED"];return!i||["GAME_OVER","GAME_OVER_SEQUENCE"].includes(i.phase)?!1:s.includes(i.phase)},isGameKey(t){return["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","KeyA","KeyD","KeyW","KeyS","KeyZ","KeyX","KeyC","KeyF","KeyP","Space","Enter","Escape","ShiftLeft","ShiftRight","ControlLeft","ControlRight"].includes(t)},processAction(t){switch(e.engine?.getState()?.phase){case"MENU":e.input.handleMenuInput(t);break;case"PLAYING":case"LOCKING":case"COUNTDOWN":e.input.handleGameplayInput(t);break;case"PAUSED":e.input.handlePausedInput(t);break;case"GAME_OVER":case"GAME_OVER_SEQUENCE":e.input.handleGameOverInput(t);break}},handleMenuInput(t){(t.type==="START_GAME"||t.type==="ENTER")&&e.handleAction({type:"START_GAME"})},handleGameplayInput(t){if(t.type==="PAUSE"||t.type==="ESCAPE"){e.handleAction({type:"PAUSE"});return}if(t.type==="ROTATE"&&t.direction===1){const i=e.engine?.getState();if(i?.current&&i.current.type==="FLOAT"){e.handleAction({type:"UP_PRESSED"});return}}if(t.type==="MOVE"&&t.dy===0){const i=e.engine?.getState();if(i?.current&&i.current.type==="FLOAT"&&(e.input.activeKeys.has("ArrowUp")||e.input.activeKeys.has("KeyW"))){e.handleAction({type:"MOVE",dx:t.dx,dy:-1});return}}e.handleAction(t)},handlePausedInput(t){(t.type==="SPACE"||t.type==="ENTER"||t.type==="ESCAPE"||t.type==="PAUSE")&&e.handleAction({type:"PAUSE"})},handleGameOverInput(t){(t.type==="SPACE"||t.type==="ENTER"||t.type==="ESCAPE")&&e.handleAction({type:"RETURN_TO_MENU"})},startAutoRepeat(t,i){if(e.input.autoRepeatTimers.has(t))return;const s=setTimeout(()=>{e.input.processAction(i),e.input.autoRepeatTimers.set(t,setInterval(()=>{e.input.processAction(i)},e.input.autoRepeatDelays.repeat))},e.input.autoRepeatDelays.initial);e.input.autoRepeatTimers.set(t,s)},stopAutoRepeat(t){const i=e.input.autoRepeatTimers.get(t);i&&(clearTimeout(i),clearInterval(i),e.input.autoRepeatTimers.delete(t))},clearAllAutoRepeat(){e.input.autoRepeatTimers.forEach(t=>{clearTimeout(t),clearInterval(t)}),e.input.autoRepeatTimers.clear()},setupListeners(){document.addEventListener("keydown",t=>e.input.onKeyDown(t)),document.addEventListener("keyup",t=>e.input.onKeyUp(t)),window.addEventListener("blur",()=>e.input.clearAllAutoRepeat()),window.addEventListener("focus",()=>e.input.clearAllAutoRepeat())},destroy:()=>{e.input.clearAllAutoRepeat(),e.input.activeKeys.clear()},clearAllRepeat:()=>{e.input.clearAllAutoRepeat()}},this.input.setupListeners(),this.inputReady=!0,window.testKeyboard=()=>{},window.keyboardHelp=()=>{},document.addEventListener("keydown",t=>{});let n=null;return setInterval(()=>{const t=this.engine?.getState()?.phase;t!==n&&(n=t)},1e3),Promise.resolve()}async loadInputController(){c||(c=(await import("./core/input-controller.js")).InputController),this.input&&this.input.destroy(),this.input=new c(e=>this.handleAction(e),()=>this.engine.getState(),this.config)}loadNonCriticalSystems(){this.nonCriticalModulesLoaded||(this.nonCriticalModulesLoaded=!0,Promise.all([import("./gameplay/particles.js"),import("./gameplay/scoring.js"),import("./gameplay/starfield.js")]).then(([e,n,t])=>{u=e.ParticleSystem,h=n.ScoringSystem,m=t.createStarfieldRenderer,this.particles=new u,this.scoring=new h,this.starfield=m()}).catch(e=>{}))}initBlockchainInBackground(){setTimeout(async()=>{try{window.timeStart&&window.timeStart("initBlockchainInBackground"),await this.blockchainManager.initialize(),this.engine&&this.engine.setBlockchainManager(this.blockchainManager),this.gameContext&&(this.gameContext.blockchain=this.blockchainManager),window.timeEnd&&window.timeEnd("initBlockchainInBackground")}catch{}},100)}setupUIBatched(){window.timeStart&&window.timeStart("setupUIBatched");const e=document.createDocumentFragment();this.cleanupOldUI(),window.timeEnd&&window.timeEnd("setupUIBatched")}setupUI(){return this.setupUIBatched()}cleanupOldUI(){}startLoop(){this.running=!0,this.render(),requestAnimationFrame(()=>this.gameLoop())}gameLoop(){if(!this.running)return;const e=performance.now(),n=Math.min(e-this.lastTime,100);this.lastTime=e,this.accumulator+=n;const t=this.config.get("game.tickRate");let i=!1,s=0;const a=10;for(;this.accumulator>=t&&s<a;)this.update(t),this.accumulator-=t,i=!0,s++;s>=a&&(this.accumulator=0),(i||this.shouldRender())&&this.render(),requestAnimationFrame(()=>this.gameLoop())}update(e){try{this.engine&&this.engine.tick(e)}catch{}}render(){if(!(!this.engine||!this.renderer))try{const e=this.engine.getState();if(!e)return;const n=this.engine.getParticles(),t={enabled:this.config.get("graphics.starfield")||!1,brightness:1,speed:.5};this.renderer.render(e,n,t)}catch{}}shouldRender(){if(!this.engine)return!1;const e=this.engine.getState();return e?e.gameState==="PLAYING"?!0:this.frameNumber%60===0:!1}handleAction(e){switch((e.type==="PAUSE"||e.type==="GAME_OVER"||e.type==="RETURN_TO_MENU")&&this.input&&typeof this.input.clearAllRepeat=="function"&&this.input.clearAllRepeat(),e.type){case"START_GAME":this.startNewGame();break;case"RETURN_TO_MENU":this.returnToMenu();break;default:this.engine&&this.engine.handleInput(e);break}}handleResize(){if(!this.renderer||!this.viewport)return;const e=this.viewport.calculateOptimalDimensions(innerWidth,innerHeight),n=document.getElementById("game"),t=document.getElementById("bg");n&&t&&(n.width=e.canvasWidth,n.height=e.canvasHeight,t.width=innerWidth,t.height=innerHeight,this.renderer.dimensions=e)}showError(e){const n=document.createElement("div");n.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.9); color: white; padding: 20px;
            border-radius: 10px; font-size: 18px; z-index: 10000; text-align: center;
        `,n.textContent=e,document.body.appendChild(n),setTimeout(()=>n.remove(),5e3)}returnToMenuViaStateManager(){this.engine&&this.engine.returnToMenu()}destroy(){this.running=!1,this.audio?.destroy(),this.input?.destroy()}async startNewGame(){if(!window.skipValidation)try{typeof r<"u"&&r.validateIdentity&&r.validateIdentity()}catch{if(!window.location.hostname.includes("pages.dev"))return}this.overlayManager.hideCurrent(),this.renderer&&typeof this.renderer.resetForNewGame=="function"&&this.renderer.resetForNewGame(),this.engine&&this.engine.returnToMenu()}async startGame(){this.engine&&this.engine.startGame()}returnToMenu(){this.overlayManager.hideCurrent(),this.stateMachine.transitionToGameState(y.MENU),this.engine&&this.engine.returnToMenu()}async showLeaderboard(){}getConfig(){return this.config||{}}bindEvents(){if(this.eventsBound)return;if(this.eventsBound=!0,!this.gameOverEventBound){this.gameOverEventBound=!0;const t=this;this.eventBus.on("gameOver",i=>{const{score:s,level:a,lines:O,time:C}=i;this.stateMachine.transitionToGameState(y.GAME_OVER)}),this.eventBus.on("gameOverUIReady",async i=>{const{score:s}=i;try{await this.overlayManager.show("gameOver",{score:s,level:0,lines:0,time:0})}catch{}})}this.eventBus.on("startGame",t=>{this.startNewGame()});let e;addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>this.handleResize(),100)}),this.setupComprehensivePauseSystem(),addEventListener("keydown",t=>{t.key==="Backspace"&&t.target===document.body&&t.preventDefault();const i=this.engine?.getState();t.key===" "&&i&&(i.phase==="MENU"?(t.preventDefault(),this.startGame()):i.phase==="GAME_OVER"&&!this.gameOverProcessing?(t.preventDefault(),this.startNewGame()):i.phase==="PAUSED"&&this.pauseState?.isPaused&&(t.preventDefault(),this.resumeFromPause()))}),window.BlockZoneMobile?.needsMobileControls()&&document.body.classList.add("touch-device");const n=()=>{this.audio&&this.audio.ctx&&this.audio.ctx.state==="suspended"&&this.audio.ctx.resume().then(()=>{})};document.addEventListener("keydown",n,{once:!0}),document.addEventListener("click",n,{once:!0}),document.addEventListener("touchstart",n,{once:!0})}setupComprehensivePauseSystem(){this.pauseState={isPaused:!1,pauseReason:null,lastPauseTime:0},document.addEventListener("visibilitychange",()=>{document.hidden&&this.engine?.getState().phase==="PLAYING"&&this.emergencyPause("PAGE_HIDDEN")}),window.addEventListener("blur",()=>{this.engine?.getState().phase==="PLAYING"&&this.emergencyPause("WINDOW_BLUR")}),window.addEventListener("focus",()=>{this.pauseState.isPaused&&this.pauseState.pauseReason==="WINDOW_BLUR"&&this.resumeFromPause()});let e;window.addEventListener("resize",()=>{this.engine?.getState().phase==="PLAYING"&&(clearTimeout(e),e=setTimeout(()=>{this.emergencyPause("RESIZE_EVENT")},100))}),document.addEventListener("fullscreenchange",()=>{this.engine?.getState().phase==="PLAYING"&&this.emergencyPause("FULLSCREEN_CHANGE")}),"getBattery"in navigator&&navigator.getBattery().then(n=>{n.addEventListener("levelchange",()=>{this.engine?.getState().phase==="PLAYING"&&this.emergencyPause("BATTERY_WARNING")})}),window.addEventListener("online",()=>{this.pauseState.isPaused&&this.pauseState.pauseReason==="NETWORK_OFFLINE"&&this.resumeFromPause()}),window.addEventListener("offline",()=>{this.engine?.getState().phase==="PLAYING"&&this.emergencyPause("NETWORK_OFFLINE")}),"Notification"in window&&Notification.permission==="granted"&&document.addEventListener("click",n=>{!(document.querySelector("#game-canvas")||document.body).contains(n.target)&&this.engine?.getState().phase==="PLAYING"&&this.emergencyPause("EXTERNAL_CLICK")})}emergencyPause(e){const n=Date.now(),t=this.engine?.getState();this.pauseState.isPaused&&n-this.pauseState.lastPauseTime<1e3||t&&t.phase==="PLAYING"&&(this.pauseState.isPaused=!0,this.pauseState.pauseReason=e,this.pauseState.lastPauseTime=n,this.engine.handleInput({type:"PAUSE"}),this.showPauseNotification(e))}resumeFromPause(){this.pauseState.isPaused&&(this.pauseState.isPaused=!1,this.pauseState.pauseReason=null,this.engine.handleInput({type:"PAUSE"}),this.hidePauseNotification())}showPauseNotification(e){let n=document.getElementById("emergency-pause-notification");n||(n=document.createElement("div"),n.id="emergency-pause-notification",n.style.cssText=`
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(255, 0, 0, 0.9);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-family: 'Bungee', monospace;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `,document.body.appendChild(n));const t={PAGE_HIDDEN:"Game paused - Page hidden",WINDOW_BLUR:"Game paused - Window lost focus",RESIZE_EVENT:"Game paused - System overlay detected",FULLSCREEN_CHANGE:"Game paused - Display mode changed",BATTERY_WARNING:"Game paused - Battery warning",NETWORK_OFFLINE:"Game paused - Network disconnected",EXTERNAL_CLICK:"Game paused - External interaction"};n.textContent=t[e]||"Game paused - System interruption"}hidePauseNotification(){const e=document.getElementById("emergency-pause-notification");e&&(e.style.animation="slideOut 0.3s ease-in",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}}async function N(){try{window.neonDrop&&window.neonDrop.destroy?.();const o=new I;return await o.initialize(),window.neonDrop=o,!0}catch{return!1}}window.startNeonDropGame=N;addEventListener("beforeunload",()=>window.neonDrop?.destroy());export{I as NeonDrop,N as startGame};
