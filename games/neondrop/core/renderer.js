import*as p from"./physics-pure.js";import{PIECE_DEFINITIONS as S,CONSTANTS as b}from"../config.js";import{ChicletRenderer as y}from"../gameplay/chiclet.js";import{createStarfieldRenderer as v}from"../gameplay/starfield.js";class A{constructor(t,e,i,o=null){this.canvas=t,this.bgCanvas=e,this.ctx=t.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1,powerPreference:"high-performance"}),this.bgCtx=e.getContext("2d",{alpha:!1,desynchronized:!0,powerPreference:"high-performance"}),this.config=i,this.dimensions=o||{blockSize:24,boardWidth:240,boardHeight:480,canvasWidth:312,canvasHeight:750,boardX:36,boardY:192},this.deviceTier=this.detectDeviceTier(),this.qualityMultiplier=this.getQualityMultiplier(),window.timeStart&&window.timeStart("renderer-init"),window.timeEnd&&window.timeEnd("renderer-init"),this.chicletRenderer=new y,this.starfieldRenderer=v(),this.premiumEffects={bloom:{enabled:this.deviceTier>=2,intensity:.3},chromaticAberration:{enabled:this.deviceTier>=3,strength:.002},volumetricLighting:{enabled:this.deviceTier>=2,samples:8},particleComplexity:this.deviceTier>=2?"ultra":"standard",shadowQuality:this.deviceTier>=2?"high":"medium",reflections:{enabled:this.deviceTier>=3,quality:"realtime"}},this.animations={countdown:{scale:1,lastNumber:0,glowIntensity:0},gameOver:{shakeX:0,shakeY:0,particles:[],initialized:!1,startTime:null,stage:1,impactWaves:[],screenDistortion:0},unlock:{alpha:0,message:"",particleTrail:[],hologramEffect:0},combo:{scale:1,count:0,alpha:0,energyRings:[],lightBurst:0}},this.transitionEffects={blur:0,fadeAlpha:0,vignetteRadius:1,desaturation:0,zoomScale:1,pixelate:0,colorShift:{r:0,g:0,b:0},screenTear:0,holographicNoise:0,energyField:0,quantumFlicker:0},this.lighting={ambientIntensity:.1,dynamicLights:[],globalIllumination:this.deviceTier>=3,shadowCascades:this.deviceTier>=2?3:1},this.particleSystems={standard:{maxParticles:100*this.qualityMultiplier},premium:{maxParticles:500*this.qualityMultiplier},ultra:{maxParticles:1e3*this.qualityMultiplier}}}detectDeviceTier(){const t=document.createElement("canvas"),e=t.getContext("webgl2")||t.getContext("webgl");if(!e)return 1;const i=e.getExtension("WEBGL_debug_renderer_info"),o=i?e.getParameter(i.UNMASKED_RENDERER_WEBGL):"",s=navigator.deviceMemory||4,n=navigator.hardwareConcurrency||4,a=/RTX|RX 6|RX 7|Apple M[1-9]|A1[4-9]|Snapdragon 8/i.test(o),r=s>=16&&n>=8,h=/iPhone1[3-9]|iPad.*A1[4-9]|Pixel [6-9]|Galaxy S2[1-9]/i.test(navigator.userAgent);return a||r||h?3:s>=8&&n>=4?2:1}getQualityMultiplier(){switch(this.deviceTier){case 3:return 2;case 2:return 1.5;case 1:return 1;default:return 1}}initialize(){this.chicletRenderer.setBlockSize(this.dimensions.blockSize),this.chicletRenderer.setScale(this.qualityMultiplier),this.precalculateLayouts(),this.initializePremiumEffects(),this.gameOverUIReadyDispatched=!1,this.setupAdvancedLighting()}initializePremiumEffects(){this.edgeGlow={maxDistance:3*this.qualityMultiplier,baseOpacity:.12*this.qualityMultiplier,maxOpacity:.25*this.qualityMultiplier,volumetricSamples:this.premiumEffects.volumetricLighting.samples,dynamicPulse:!0,colorShifting:this.deviceTier>=3,edges:{left:{x:this.dimensions.boardX-20*this.qualityMultiplier,y:this.dimensions.boardY,width:25*this.qualityMultiplier,height:this.dimensions.boardHeight},right:{x:this.dimensions.boardX+this.dimensions.boardWidth-5*this.qualityMultiplier,y:this.dimensions.boardY,width:25*this.qualityMultiplier,height:this.dimensions.boardHeight},bottom:{x:this.dimensions.boardX,y:this.dimensions.boardY+this.dimensions.boardHeight-5*this.qualityMultiplier,width:this.dimensions.boardWidth,height:25*this.qualityMultiplier}}},this.premiumEffects.bloom.enabled&&(this.bloomBuffer=document.createElement("canvas"),this.bloomBuffer.width=this.canvas.width,this.bloomBuffer.height=this.canvas.height,this.bloomCtx=this.bloomBuffer.getContext("2d"))}setupAdvancedLighting(){this.lighting.dynamicLights=[{type:"ambient",color:[.1,.1,.2],intensity:.3},{type:"directional",direction:[.5,-1,.5],color:[1,.9,.8],intensity:.7}]}resetForNewGame(){this.gameOverUIReadyDispatched=!1,this.animations.gameOver={shakeX:0,shakeY:0,particles:[],initialized:!1,startTime:null,stage:1,impactWaves:[],screenDistortion:0},this.transitionEffects={blur:0,fadeAlpha:0,vignetteRadius:1,desaturation:0,zoomScale:1,pixelate:0,colorShift:{r:0,g:0,b:0},screenTear:0,holographicNoise:0,energyField:0,quantumFlicker:0}}render(t,e=[],i=null){if(this.updateTransitionEffects(t),this.clearCanvas(),this.transitionEffects.blur>0?this.canvas.style.filter=`blur(${this.transitionEffects.blur}px)`:this.canvas.style.filter="none",this.renderBackground(i),this.transitionEffects.zoomScale!==1){this.ctx.save();const s=this.dimensions.boardX+this.dimensions.boardWidth/2,n=this.dimensions.boardY+this.dimensions.boardHeight/2;this.ctx.translate(s,n),this.ctx.scale(this.transitionEffects.zoomScale,this.transitionEffects.zoomScale),this.ctx.translate(-s,-n)}const o=this.animations.gameOver.shakeX!==0;o&&(this.ctx.save(),this.ctx.translate(this.animations.gameOver.shakeX,this.animations.gameOver.shakeY)),this.renderBoard(t),this.renderActivePieces(t),this.renderEdgeGlow(t),this.renderParticles(e),this.renderParticlesOverflow(e),o&&(this.ctx.restore(),this.updateShake()),this.transitionEffects.zoomScale!==1&&this.ctx.restore(),this.renderUI(t),this.renderPostProcessing(t),this.renderOverlays(t),t.timeDilation&&t.timeDilation!==1&&this.renderTimeDilationEffect(t.timeDilation),t.gameMode==="practice"&&this.renderPracticeIndicator()}updateTransitionEffects(t){if(!t.transition){this.transitionEffects={blur:0,fadeAlpha:0,vignetteRadius:1,desaturation:0,zoomScale:1,pixelate:0,colorShift:{r:0,g:0,b:0},screenTear:0,holographicNoise:0,energyField:0,quantumFlicker:0};return}const{type:e,progress:i}=t.transition;switch(e){case"menu-fade":this.transitionEffects.fadeAlpha=i,this.transitionEffects.zoomScale=1+i*.05;break;case"countdown-end":const o=Math.sin(i*Math.PI);this.transitionEffects.zoomScale=1+o*.02;break;case"pause":this.transitionEffects.blur=i*8;break;case"unpause":this.transitionEffects.blur=(1-i)*8;break;case"game-over-slow":this.transitionEffects.zoomScale=1-i*.03;break;case"game-over-fade":this.transitionEffects.vignetteRadius=1-i*.8,this.transitionEffects.desaturation=i,this.transitionEffects.fadeAlpha=i*.8;break;case"fade-out":this.transitionEffects.fadeAlpha=i;break}}renderPostProcessing(t){if(this.transitionEffects.desaturation>0&&(this.ctx.save(),this.ctx.globalCompositeOperation="saturation",this.ctx.fillStyle=`rgba(128, 128, 128, ${this.transitionEffects.desaturation})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()),this.transitionEffects.vignetteRadius<1){const e=this.dimensions.boardX+this.dimensions.boardWidth/2,i=this.dimensions.boardY+this.dimensions.boardHeight/2,o=Math.sqrt(Math.pow(this.dimensions.boardWidth/2,2)+Math.pow(this.dimensions.boardHeight/2,2)),s=this.ctx.createRadialGradient(e,i,o*this.transitionEffects.vignetteRadius,e,i,o*1.5);s.addColorStop(0,"rgba(0, 0, 0, 0)"),s.addColorStop(1,"rgba(0, 0, 0, 1)"),this.ctx.fillStyle=s,this.ctx.fillRect(this.dimensions.boardX,this.dimensions.boardY,this.dimensions.boardWidth,this.dimensions.boardHeight)}this.transitionEffects.fadeAlpha>0&&(this.ctx.fillStyle=`rgba(0, 0, 0, ${this.transitionEffects.fadeAlpha})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))}renderTimeDilationEffect(t){if(t>=.8)return;const e=this.dimensions.boardX+this.dimensions.boardWidth/2,i=this.dimensions.boardY+this.dimensions.boardHeight/2,o=Math.sin(Date.now()*.01)*.05+.95;this.ctx.save(),this.ctx.globalAlpha=(1-t)*.1;const s=this.ctx.createRadialGradient(e,i,0,e,i,this.dimensions.boardWidth*o);s.addColorStop(0,"rgba(255, 255, 255, 0)"),s.addColorStop(.5,"rgba(255, 255, 255, 0.05)"),s.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=s,this.ctx.fillRect(this.dimensions.boardX,this.dimensions.boardY,this.dimensions.boardWidth,this.dimensions.boardHeight),this.ctx.restore()}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.bgCtx.clearRect(0,0,this.bgCanvas.width,this.bgCanvas.height)}renderBackground(t){t?.enabled?this.starfieldRenderer.render(this.bgCtx,t,{width:this.bgCanvas.width,height:this.bgCanvas.height}):(this.bgCtx.fillStyle="#000000",this.bgCtx.fillRect(0,0,this.bgCanvas.width,this.bgCanvas.height))}renderBoard(t){this.ctx.fillStyle="#000000",this.ctx.fillRect(this.dimensions.boardX,this.dimensions.boardY,this.dimensions.boardWidth,this.dimensions.boardHeight),this.config.get("graphics.showGrid")&&this.renderGrid(),this.renderBoardPieces(t.board,t.clearingLines)}renderBoardPieces(t,e=[]){for(let i=0;i<t.length;i++)for(let o=0;o<t[i].length;o++){const s=t[i][o];if(!s)continue;if(e.includes(i)){const r=Math.sin(Date.now()*.05)*.5+.5;this.ctx.globalAlpha=.5+r*.5}const n=this.dimensions.boardX+o*this.dimensions.blockSize,a=this.dimensions.boardY+i*this.dimensions.blockSize;this.chicletRenderer.drawBlock(this.ctx,n,a,s,i,o),this.ctx.globalAlpha=1}}renderActivePieces(t){if(!t.current)return;this.config.get("graphics.ghostPiece")&&(t.phase==="PLAYING"||t.phase==="LOCKING")&&this.renderGhostPiece(t),t.phase==="GAME_OVER"||t.phase==="GAME_OVER_SEQUENCE"&&t.gameOverSequencePhase>0||this.renderCurrentPiece(t)}renderGhostPiece(t){if(t.shadowY===t.current.gridY)return;const e=this.config.get("graphics.ghostPieceOpacity")||.15;this.ctx.globalAlpha=e,this.drawPieceWithSpawn(t.current,t.current.gridX,t.shadowY,0,!0),this.ctx.globalAlpha=1}renderCurrentPiece(t){if(!t.current)return;let e=1,i=0;if(t.phase==="PLAYING"&&t.current.gridY<t.shadowY){i=Math.min(1,t.gravityAccumulator/t.currentGravityDelay)*this.dimensions.blockSize;const s=t.current.gridY*this.dimensions.blockSize+i,n=t.shadowY*this.dimensions.blockSize;s>n&&(i=n-t.current.gridY*this.dimensions.blockSize)}if(t.phase==="LOCKING"&&t.lockTimer&&!t.isSpawning){const o=this.getLockDelay(t.current.type),n=3+Math.min(1,t.lockTimer/o)*12;e*=Math.sin(Date.now()*.001*n)*.3+.7}this.ctx.globalAlpha=e,this.drawPieceWithSpawn(t.current,t.current.gridX,t.current.gridY,i,!1),this.ctx.globalAlpha=1}drawPieceWithSpawn(t,e,i,o,s=!1){t.shape.forEach((n,a)=>{n.forEach((r,h)=>{if(!r)return;const c=e+h,l=i+a;if(l<-6||l>=20||c<0||c>=10)return;let d=t.color,m=1;if(s||(m=p.getBlockSpawnOpacity(t,i,o,a)),s)d="#404040";else if(t.type==="FLOAT"&&t.upMovesUsed>0){const u=255-t.upMovesUsed*30,f=Math.max(0,u).toString(16).padStart(2,"0");d=`#${f}${f}${f}`}const g=this.dimensions.boardX+c*this.dimensions.blockSize,x=this.dimensions.boardY+l*this.dimensions.blockSize+o;this.ctx.save(),s?this.ctx.globalAlpha=this.ctx.globalAlpha*m:this.ctx.globalAlpha=m;try{this.chicletRenderer.drawBlock(this.ctx,g,x,d,l,c,s?null:t)}catch{this.ctx.fillStyle=d,this.ctx.fillRect(g,x,this.dimensions.blockSize,this.dimensions.blockSize),this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.ctx.strokeRect(g,x,this.dimensions.blockSize,this.dimensions.blockSize)}this.ctx.restore()})})}renderDeathPiece(t){t&&t.shape.forEach((e,i)=>{e.forEach((o,s)=>{if(!o)return;const n=t.gridX+s,a=t.gridY+i;if(n>=0&&n<b.BOARD.WIDTH){const r=this.dimensions.boardX+n*this.dimensions.blockSize,h=this.dimensions.boardY+a*this.dimensions.blockSize;this.chicletRenderer.drawBlock(this.ctx,r,h,"#FF0000",a,n)}})})}renderUI(t){this.renderTitle(),this.renderScore(t),this.renderStats(t),this.renderPreviewAndHold(t),this.renderNotifications(t)}renderTitle(){const t=this.dimensions.blockSize,e=this.dimensions.zones.title;for(let i=0;i<4;i++){const o=e.x+i*t;this.renderTitleLetter("NEON"[i],o,e.y,"#FFFF00",t)}for(let i=0;i<4;i++){const o=e.x+(i+6)*t;this.renderTitleLetter("DROP"[i],o,e.y,"#8A2BE2",t)}}renderTitleLetter(t,e,i,o,s){const n=document.createElement("canvas");n.width=s,n.height=s;const a=n.getContext("2d");a.clearRect(0,0,s,s),this.chicletRenderer.drawBlock(a,0,0,o,0,0),a.save(),a.globalCompositeOperation="destination-out",a.font=`bold ${s*1.2}px Bungee, monospace`,a.textAlign="center",a.textBaseline="middle",a.fillText(t,s/2,s/2+s*.1),a.restore(),a.strokeStyle="#000000",a.lineWidth=1,a.font=`bold ${s*1.2}px Bungee, monospace`,a.textAlign="center",a.textBaseline="middle",a.strokeText(t,s/2,s/2+s*.1),this.ctx.drawImage(n,e,i)}renderScore(t){if(t.phase==="COUNTDOWN"||t.phase==="COUNTDOWN_TO_PLAYING"||t.phase==="MENU_TO_COUNTDOWN")return;const e=this.dimensions.zones.score;if(this.ctx.font=`${this.dimensions.blockSize*.6}px monospace`,this.ctx.textBaseline="top",this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText(`P1 ${t.score.toString().padStart(6,"0")}`,e.x,e.y),this.ctx.textAlign="right",t.isNewHighScore&&t.score>0){const i=Math.sin(Date.now()*.005)*.5+.5;this.ctx.fillStyle=`rgb(255, ${Math.floor(255*i)}, 0)`}else this.ctx.fillStyle="#FFFFFF";this.ctx.fillText(`HS ${(t.displayHighScore||0).toString().padStart(6,"0")}`,e.x+e.width,e.y)}renderStats(t){this.statsBottom=this.dimensions.zones.score.y+this.dimensions.blockSize*.7}renderPreviewAndHold(t){if(t.next&&t.phase!=="GAME_OVER"&&t.phase!=="MENU"){const e=this.pieceLayouts.get(t.next.type);if(e){const o=Math.floor(this.dimensions.blockSize*.6*.75),s=Math.floor(this.dimensions.blockSize*.15*.75),n=e.height*(o+s)-s,a=this.dimensions.zones.preview,r=a.y-n;this.renderMiniPieceAtPosition(t.next,a.centerX,r,.75,.5)}}if(t.hold){const e=this.dimensions.zones.hold;if(this.pieceLayouts.get(t.hold.type)){const s=t.canHold?.5:.25;this.renderMiniPieceAtPosition(t.hold,e.centerX,e.y,.75,s)}}}renderMiniPieceAtPosition(t,e,i,o,s){const n=this.pieceLayouts.get(t.type);if(!n)return;const a=Math.floor(this.dimensions.blockSize*.6*o),r=Math.floor(this.dimensions.blockSize*.15*o);this.ctx.save(),this.ctx.globalAlpha=s;const h=n.width*(a+r)-r,c=e-h/2;n.blocks.forEach(({dx:l,dy:d})=>{const m=c+l*(a+r),g=i+d*(a+r);this.drawMiniBlock(m,g,a,t.color)}),this.ctx.restore()}drawMiniBlock(t,e,i,o){const s=i*.3;this.ctx.beginPath(),this.ctx.moveTo(t+s,e),this.ctx.lineTo(t+i-s,e),this.ctx.quadraticCurveTo(t+i,e,t+i,e+s),this.ctx.lineTo(t+i,e+i-s),this.ctx.quadraticCurveTo(t+i,e+i,t+i-s,e+i),this.ctx.lineTo(t+s,e+i),this.ctx.quadraticCurveTo(t,e+i,t,e+i-s),this.ctx.lineTo(t,e+s),this.ctx.quadraticCurveTo(t,e,t+s,e),this.ctx.closePath(),this.ctx.fillStyle=o,this.ctx.fill();const n=this.ctx.createRadialGradient(t+i/2,e+i/2,i*.1,t+i/2,e+i/2,i*.7);n.addColorStop(0,"rgba(255, 255, 255, 0.3)"),n.addColorStop(1,"rgba(0, 0, 0, 0.2)"),this.ctx.fillStyle=n,this.ctx.fill()}renderOverlays(t){switch(t.phase){case"MENU":this.renderMenu(t);break;case"MENU_TO_COUNTDOWN":this.renderMenuTransition(t);break;case"COUNTDOWN":this.renderCountdown(t);break;case"COUNTDOWN_TO_PLAYING":this.renderCountdownTransition(t);break;case"PLAYING_TO_PAUSE":case"PAUSED":case"PAUSE_TO_PLAYING":this.renderPaused(t);break;case"GAME_OVER_SEQUENCE":case"GAME_OVER":case"GAME_OVER_TO_MENU":this.renderGameOverSequence(t);break}}renderMenu(t){this.dimBoard(.7),this.renderTitle();const e=Math.sin(Date.now()*.001)*.3+.7;this.ctx.save(),this.ctx.globalAlpha=e,this.ctx.font=`${this.dimensions.blockSize*.6}px monospace`,this.ctx.fillStyle="#FFFF00",this.ctx.textAlign="center",this.ctx.shadowColor="#FFFF00",this.ctx.shadowBlur=10;const i=this.dimensions.boardX+this.dimensions.boardWidth/2,o=this.dimensions.zones.title.y+this.dimensions.blockSize*3;this.ctx.fillText("PRESS SPACE TO START",i,o),this.ctx.restore()}renderMenuTransition(t){const i=1-(t.transition?.progress||0);if(this.dimBoard(.7*i),i>.01){this.ctx.save(),this.ctx.globalAlpha=i,this.ctx.font=`${this.dimensions.blockSize*.7}px monospace`,this.ctx.fillStyle="#FFFF00",this.ctx.textAlign="center",this.ctx.shadowColor="#FFFF00",this.ctx.shadowBlur=10*i;const o=this.dimensions.boardX+this.dimensions.boardWidth/2,s=this.dimensions.boardY+this.dimensions.boardHeight/2;this.ctx.fillText("PRESS SPACE TO START",o,s),this.ctx.restore()}}renderCountdown(t){this.dimBoard(.5);const e=Math.ceil((t.countdownTimer||0)/1e3);e!==this.animations.countdown.lastNumber&&(this.animations.countdown.lastNumber=e,this.animations.countdown.scale=2),this.animations.countdown.scale=Math.max(1,this.animations.countdown.scale*.95);const i=this.dimensions.boardX+this.dimensions.boardWidth/2,o=this.dimensions.boardY+this.dimensions.boardHeight/2;this.ctx.save(),this.ctx.translate(i,o),this.ctx.scale(this.animations.countdown.scale,this.animations.countdown.scale),this.ctx.font=`bold ${this.dimensions.blockSize*3}px monospace`,this.ctx.fillStyle=e===1?"#FF0000":"#FFFF00",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.shadowColor=this.ctx.fillStyle,this.ctx.shadowBlur=20,this.ctx.fillText(e.toString(),0,0),this.ctx.restore()}renderCountdownTransition(t){const e=t.transition?.progress||0,i=1-e;if(this.dimBoard(.5*i),i>.01){const o=this.dimensions.boardX+this.dimensions.boardWidth/2,s=this.dimensions.boardY+this.dimensions.boardHeight/2;this.ctx.save(),this.ctx.globalAlpha=i,this.ctx.translate(o,s);const n=1+e*3;this.ctx.scale(n,n),this.ctx.font=`bold ${this.dimensions.blockSize*3}px monospace`,this.ctx.fillStyle="#FF0000",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.shadowColor=this.ctx.fillStyle,this.ctx.shadowBlur=20,this.ctx.fillText("1",0,0),this.ctx.restore()}}renderPaused(t){const e=t.transition?.progress||1,o=t.phase==="PAUSE_TO_PLAYING"?1-e:e;this.dimBoard(.7);const s=Math.sin(Date.now()*.003)*.1+.9;this.ctx.save();const n=(1-o)*-50;this.ctx.translate(0,n),this.ctx.globalAlpha=o*s,this.ctx.font=`${this.dimensions.blockSize*1.5}px monospace`,this.ctx.fillStyle="#FFFF00",this.ctx.textAlign="center",this.ctx.shadowColor="#FFFF00",this.ctx.shadowBlur=15;const a=this.dimensions.boardX+this.dimensions.boardWidth/2,r=this.dimensions.boardY+this.dimensions.boardHeight/2;this.ctx.fillText("PAUSED",a,r),this.ctx.restore()}renderGameOverSequence(t){const e=Date.now(),i=e-t.gameOverStartTime;if(i<3e3){if(t.deathPiece){const a=Math.sin(e*.001*2*Math.PI)*.5+.5,r=i/3e3,h=r>.8?(1-r)/.2:1;this.ctx.save(),this.ctx.globalAlpha=a*h,this.renderDeathPiece(t.deathPiece),this.ctx.restore()}return}const o=i-3e3,s=Math.min(1,o/4e3);this.ctx.save(),this.ctx.globalAlpha=1-s,this.renderBoard(t),this.ctx.restore(),this.renderProfessionalGameOverText(t,s),s>=1&&!this.gameOverUIReadyDispatched&&(this.gameOverUIReadyDispatched=!0,document.dispatchEvent(new CustomEvent("gameOverUIReady",{detail:{score:t.score}})))}renderProfessionalGameOverText(t,e){const i=this.dimensions.boardX,o=this.dimensions.boardY,s=this.dimensions.boardWidth,n=this.dimensions.boardHeight,a=i+s/2,r=o+n/2;this.ctx.save();const h=Math.min(1,e*2);this.ctx.globalAlpha=h;const c=Math.min(s*.15,n*.1);this.ctx.font=`bold ${c}px monospace`,this.ctx.fillStyle="#FF0000",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.shadowColor="#FF0000",this.ctx.shadowBlur=c*.2,this.ctx.shadowOffsetX=c*.02,this.ctx.shadowOffsetY=c*.02,this.ctx.fillText("GAME OVER",a,r);const l=Math.sin(Date.now()*.005)*.2+.8;this.ctx.globalAlpha=h*l*.7,this.ctx.shadowBlur=c*.3,this.ctx.fillText("GAME OVER",a,r),this.ctx.restore()}updateShake(){this.animations.gameOver.shakeX!==0&&(this.animations.gameOver.shakeX*=.9,this.animations.gameOver.shakeY*=.9,Math.abs(this.animations.gameOver.shakeX)<.1?(this.animations.gameOver.shakeX=0,this.animations.gameOver.shakeY=0):(this.animations.gameOver.shakeX=(Math.random()-.5)*this.animations.gameOver.shakeX,this.animations.gameOver.shakeY=(Math.random()-.5)*this.animations.gameOver.shakeY))}renderNotifications(t){if(!(t.phase==="GAME_OVER"||t.phase==="GAME_OVER_SEQUENCE"||t.phase==="GAME_OVER_TO_MENU")){if(t.lastUnlockScore>0&&t.score>=t.lastUnlockScore&&t.score<t.lastUnlockScore+1e3){this.animations.unlock.alpha<1&&(this.animations.unlock.alpha=Math.min(1,this.animations.unlock.alpha+.1),this.animations.unlock.message="NEW PIECE UNLOCKED!"),this.ctx.save(),this.ctx.globalAlpha=this.animations.unlock.alpha,this.ctx.font=`bold ${this.dimensions.blockSize*.75}px monospace`,this.ctx.fillStyle="#FFD700",this.ctx.textAlign="center",this.ctx.shadowColor="#FFD700",this.ctx.shadowBlur=10;const e=this.dimensions.boardX+this.dimensions.boardWidth/2,i=this.dimensions.boardY-this.dimensions.blockSize*2-5;this.ctx.fillText(this.animations.unlock.message,e,i),this.ctx.restore()}else this.animations.unlock.alpha=Math.max(0,this.animations.unlock.alpha-.05);if(t.combo>1&&t.phase!=="GAME_OVER"&&t.phase!=="GAME_OVER_SEQUENCE"){this.animations.combo.count!==t.combo&&(this.animations.combo.count=t.combo,this.animations.combo.scale=2,this.animations.combo.alpha=1),this.animations.combo.scale=Math.max(1,this.animations.combo.scale*.95),this.animations.combo.alpha=Math.max(0,this.animations.combo.alpha-.02);const e=this.dimensions.boardX+this.dimensions.boardWidth/2,i=this.dimensions.boardY+this.dimensions.boardHeight+this.dimensions.blockSize*2+5;this.ctx.save(),this.ctx.globalAlpha=this.animations.combo.alpha,this.ctx.font=`bold ${this.dimensions.blockSize*.75}px monospace`,this.ctx.fillStyle="#FFD700",this.ctx.textAlign="center",this.ctx.shadowColor="#FFD700",this.ctx.shadowBlur=10,this.ctx.fillText(`${t.combo}x COMBO!`,e,i),this.ctx.restore()}else this.animations.combo.count=0,this.animations.combo.alpha=0}}renderParticles(t){t.length!==0&&t.forEach(e=>{this.ctx.save(),this.ctx.globalAlpha=e.opacity||1;const i=this.dimensions.boardX+e.x,o=this.dimensions.boardY+e.y;if(e.type==="glow"){const s=this.ctx.createRadialGradient(i,o,0,i,o,e.size);s.addColorStop(0,e.color),s.addColorStop(.4,e.color),s.addColorStop(1,"transparent"),this.ctx.fillStyle=s,this.ctx.fillRect(i-e.size,o-e.size,e.size*2,e.size*2)}else e.type==="spark"?(this.ctx.strokeStyle=e.color,this.ctx.lineWidth=e.size*.5,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(i-e.vx*.1,o-e.vy*.1),this.ctx.lineTo(i,o),this.ctx.stroke()):e.type==="lightSparkler"?(this.ctx.fillStyle=e.color,this.ctx.fillRect(i-e.size/2,o-e.size/2,e.size,e.size)):(this.ctx.fillStyle=e.color,this.ctx.fillRect(i-e.size/2,o-e.size/2,e.size,e.size));this.ctx.restore()})}renderParticlesOverflow(t){if(t.length===0)return;const e=this.canvas.getBoundingClientRect(),i=t.filter(o=>{const s=this.dimensions.boardX+o.x,n=this.dimensions.boardY+o.y;return s<0||s>this.dimensions.canvasWidth||n<0||n>this.dimensions.canvasHeight});i.length!==0&&i.forEach(o=>{this.bgCtx.save(),this.bgCtx.globalAlpha=o.opacity||1;const s=e.left+this.dimensions.boardX+o.x,n=e.top+this.dimensions.boardY+o.y;this.bgCtx.fillStyle=o.color,this.bgCtx.fillRect(s-o.size/2,n-o.size/2,o.size,o.size),this.bgCtx.restore()})}renderEdgeGlow(t){if(!this.config.get("graphics.edgeGlow"))return;const e={left:0,right:0,bottom:0};t.current&&(t.phase==="PLAYING"||t.phase==="LOCKING")&&t.current.shape.forEach((i,o)=>{i.forEach((s,n)=>{if(!s)return;const a=t.current.gridX+n,r=t.current.gridY+o;if(!(r<0)){if(a<=this.edgeGlow.maxDistance){const h=1-a/this.edgeGlow.maxDistance;e.left=Math.max(e.left,h)}if(a>=10-this.edgeGlow.maxDistance-1){const h=1-(9-a)/this.edgeGlow.maxDistance;e.right=Math.max(e.right,h)}if(r>=20-this.edgeGlow.maxDistance-1){const h=1-(19-r)/this.edgeGlow.maxDistance;e.bottom=Math.max(e.bottom,h)}}})}),this.ctx.save(),["left","right","bottom"].forEach(i=>{e[i]>.01&&this.renderEdge(i,e[i])}),this.ctx.restore()}renderEdge(t,e){const i=this.edgeGlow.edges[t],o=this.edgeGlow.baseOpacity+(this.edgeGlow.maxOpacity-this.edgeGlow.baseOpacity)*e;let s;switch(t){case"left":s=this.ctx.createLinearGradient(i.x,i.y,i.x+i.width,i.y);break;case"right":s=this.ctx.createLinearGradient(i.x+i.width,i.y,i.x,i.y);break;case"bottom":s=this.ctx.createLinearGradient(i.x,i.y+i.height,i.x,i.y);break}s.addColorStop(0,"rgba(138, 43, 226, 0)"),s.addColorStop(.3,`rgba(138, 43, 226, ${o*.7})`),s.addColorStop(.7,`rgba(138, 43, 226, ${o})`),s.addColorStop(1,"rgba(138, 43, 226, 0)"),this.ctx.fillStyle=s,this.ctx.fillRect(i.x,i.y,i.width,i.height)}renderGrid(){this.ctx.strokeStyle="rgba(255, 255, 255, 0.05)",this.ctx.lineWidth=1,this.ctx.beginPath();for(let t=1;t<10;t++){const e=this.dimensions.boardX+t*this.dimensions.blockSize;this.ctx.moveTo(e,this.dimensions.boardY),this.ctx.lineTo(e,this.dimensions.boardY+this.dimensions.boardHeight)}for(let t=1;t<20;t++){const e=this.dimensions.boardY+t*this.dimensions.blockSize;this.ctx.moveTo(this.dimensions.boardX,e),this.ctx.lineTo(this.dimensions.boardX+this.dimensions.boardWidth,e)}this.ctx.stroke()}dimBoard(t){this.ctx.fillStyle=`rgba(0, 0, 0, ${t})`,this.ctx.fillRect(this.dimensions.boardX,this.dimensions.boardY,this.dimensions.boardWidth,this.dimensions.boardHeight)}getLockDelay(t){return t==="FLOAT"?b.TIMING.LOCK_DELAY_FLOAT:b.TIMING.LOCK_DELAY}precalculateLayouts(){this.pieceLayouts=new Map,Object.entries(S).forEach(([t,e])=>{const i=[];let o=e.shape[0].length,s=0,n=e.shape.length,a=0;e.shape.forEach((h,c)=>{h.forEach((l,d)=>{l&&(i.push({dx:d,dy:c}),o=Math.min(o,d),s=Math.max(s,d),n=Math.min(n,c),a=Math.max(a,c))})});const r=i.map(h=>({dx:h.dx-o,dy:h.dy-n}));this.pieceLayouts.set(t,{blocks:r,width:s-o+1,height:a-n+1})})}renderPracticeIndicator(){this.ctx.save(),this.ctx.fillStyle="rgba(128, 128, 128, 0.7)",this.ctx.font="14px monospace",this.ctx.fillText("PRACTICE MODE - No Rewards",10,25),this.ctx.restore()}toggleGrid(){const t=this.config.get("graphics.showGrid");this.config.set("graphics.showGrid",!t)}resetAnimations(){this.animations={countdown:{scale:1,lastNumber:0,glowIntensity:0},gameOver:{shakeX:0,shakeY:0,particles:[],initialized:!1,startTime:null,stage:1,impactWaves:[],screenDistortion:0},unlock:{alpha:0,message:"",particleTrail:[],hologramEffect:0},combo:{scale:1,count:0,alpha:0,energyRings:[],lightBurst:0}},this.transitionEffects={blur:0,fadeAlpha:0,vignetteRadius:1,desaturation:0,zoomScale:1,pixelate:0,colorShift:{r:0,g:0,b:0},screenTear:0,holographicNoise:0,energyField:0,quantumFlicker:0},this.canvas.style.filter="none"}}export{A as Renderer};
